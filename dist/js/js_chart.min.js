function AxisLabelX(t,e,a,i){var n=document.createElementNS("http://www.w3.org/2000/svg","text");n.setAttribute("y",a),n.textContent=i,t.appendChild(n),this.el=n,this.state=10,n.className.baseVal="label-off",setTimeout((function(){n.className.baseVal="label-on "}),0),this.setX=function(t){n.getAttribute("x")!=t&&n.setAttribute("x",t)},this.setY=function(t){n.getAttribute("y")!=t&&n.setAttribute("y",t)},this.update=function(){-10===this.state&&(n.className.baseVal="label-on "),this.state=10,this.timeoutid&&(clearTimeout(this.timeoutid),this.timeoutid=null)},this.remove=function(e){-10!==this.state&&(n.className.baseVal="label-off",this.state=-10,this.timeoutid=setTimeout((function(){t.removeChild(n),e()}),2e3))}}function AxisLabelY(t,e,a,i,n){var s=parseFloat(getComputedStyle(t).fontSize),r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",a+s/2),r.setAttribute("y",i-s/2),r.textContent=n,t.appendChild(r),this.el=r,this.state=10,r.className.baseVal="label-off";var o=this,l=document.createElementNS("http://www.w3.org/2000/svg","line");l.setAttribute("x1",0),l.setAttribute("x2","100%"),e.appendChild(l),l.className.baseVal="label-off",setTimeout((function(){r.className.baseVal="label-on ",l.className.baseVal="label-on "}),0),this.setY=function(t){r.getAttribute("y")!=t-s/2&&r.setAttribute("y",t-s/2),l.getAttribute("y1")!=t&&l.setAttribute("y1",t),l.getAttribute("y2")!=t&&l.setAttribute("y2",t)},this.update=function(){-10===this.state&&(r.className.baseVal="label-on ",l.className.baseVal="label-on "),o.state=10,o.timeoutid&&(clearTimeout(this.timeoutid),o.timeoutid=null)},this.remove=function(a){-10!==o.state&&(r.className.baseVal="label-off",l.className.baseVal="label-off",o.state=-10,o.timeoutid=setTimeout((function(){t.removeChild(r),e.removeChild(l),a()}),2e3))}}function toDateStr(t,e){var a=new Date(t),i=a.getDate(),n=a.getMonth();return(e?["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][a.getDay()]+", ":"")+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][n]+" "+i}function XScale(t,e,a,i){this.labels=new Map;var n=document.createElementNS("http://www.w3.org/2000/svg","g");n.className.baseVal="labels x-labels",t.appendChild(n);var s,r;this.update=function(){var t=e.low,o=e.high,l=parseFloat(getComputedStyle(n).fontSize),h=o-t;this.range!==h&&(this.range=h,this.step=864e5*Math.pow(2,Math.round(Math.log2(h/864e5/i))));var u=this.step,c=e.origin%u,d=this.labels;s===a.box.y&&r===a.box.h||d.forEach((function(t,e){t.setY(a.box.y+a.box.h+l+l/2)})),s=a.box.y,r=a.box.h,d.forEach((function(t,e){t.state>0&&(t.state=0)}));for(var p=Math.floor(t/u)*u+c;p<o;p+=u)d.has(p)?d.get(p).update():d.set(p,new AxisLabelX(n,0,a.box.y+a.box.h+l+l/2,toDateStr(p)));d.forEach((function(e,i){e.setX(a.toView(i,"x")),(i<t||i>o||0===e.state)&&e.remove((function(){d.delete(i)}))}))}}function YScale(t,e,a,i){var n=this;this.labels=new Map;var s=document.createElementNS("http://www.w3.org/2000/svg","g");s.className.baseVal="labels y-labels",t.appendChild(s);var r=document.createElementNS("http://www.w3.org/2000/svg","g");r.className.baseVal="grid y-grid",t.appendChild(r),this.update=function(){var t=e.low,i=e.high;n.low=t,n.high=i;var o=i-t,l=parseFloat(getComputedStyle(s).fontSize),h=Math.max(a.box.h/(4*l),3);n.range===o&&n.tickcnt===h||(n.range=o,n.tickcnt=h,o>10*h?(this.step=Math.pow(10,Math.ceil(Math.log10(o/h))),o/this.step<1*h/5?this.step=this.step/5:o/this.step<3*h/5&&(this.step=this.step/2)):n.step=o>5*h?5*Math.ceil(o/h/5):Math.ceil(o/h));var u=n.step,c=e.origin%u,d=n.labels;d.forEach((function(t,e){t.state>0&&(t.state=0)}));for(var p=Math.floor(t/u)*u+c;p<i;p+=u)d.has(p)?d.get(p).update():d.set(p,new AxisLabelY(s,r,a.box.x,0,p));d.forEach((function(e,n){e.setY(a.toView(n,"y")),(n<t||n>i||0===e.state)&&e.remove((function(){d.delete(n)}))}))}}function throttle(t,e){var a,i;return function(){var n=this,s=arguments;i?(clearTimeout(a),a=setTimeout((function(){Date.now()-i>=e&&(t.apply(n,s),i=Date.now())}),e-(Date.now()-i))):(t.apply(n,s),i=Date.now())}}function getMousePosition(t,e){var a=e.getScreenCTM();return t.touches&&(t=t.touches[0]),{x:(t.clientX-a.e)/a.a,y:(t.clientY-a.f)/a.d}}function Navigator(t,e,a,i){var n=document.createElementNS("http://www.w3.org/2000/svg","g");n.className.baseVal="nav",this.el=n;var s,r,o={l:document.createElementNS("http://www.w3.org/2000/svg","rect"),bl:document.createElementNS("http://www.w3.org/2000/svg","rect"),p:document.createElementNS("http://www.w3.org/2000/svg","rect"),br:document.createElementNS("http://www.w3.org/2000/svg","rect"),r:document.createElementNS("http://www.w3.org/2000/svg","rect")};for(var l in o)o[l].setAttribute("id",l),"r"!==l&&"l"!==l?"p"!==l?(o[l].className.baseVal="nav-brd draggable",n.appendChild(o[l])):o[l].className.baseVal="nav-pos draggable":o[l].className.baseVal="nav-cover draggable";n.appendChild(i),n.appendChild(o.p),n.appendChild(o.l),n.appendChild(o.r);var h=function(t){t.target.classList.contains("draggable")&&(s=t.target,(r=getMousePosition(t,n)).x-=parseFloat(s.getAttribute("x")),r.y-=parseFloat(s.getAttribute("y")))},u=this;this.boundWeigth=10;var c=throttle((function(t){var i=getMousePosition(t,n),l=i.x-r.x;if(l,!(i.x<a.box.x||i.x+u.boundWeigth>a.box.x+a.box.w)){var h=0;s==o.bl||s==o.l?(h=a.toUnit(i.x),e.setRange(h,e.high)):s==o.p?(h=a.toUnit(l-u.boundWeigth),e.setRange(h,h+e.high-e.low)):s!=o.br&&s!=o.r||(h=a.toUnit(i.x+u.boundWeigth),e.setRange(e.low,h))}}),50);function d(t){s&&(t.preventDefault(),c(t))}function p(t){s=!1}t.appendChild(n),n.addEventListener("mousedown",h),n.addEventListener("mousemove",d),n.addEventListener("mouseup",p),n.addEventListener("mouseleave",p),n.addEventListener("touchstart",h,!1),t.addEventListener("touchmove",d,!0),n.addEventListener("touchend",p,!1),n.addEventListener("touchcancel",p,!1),this.update=function(){!(function(t,e){var i;if(o.l.getAttribute("x")!=a.box.x&&o.l.setAttribute("x",a.box.x),o.l.getAttribute("y")!=a.box.y)for(i in o)o[i].setAttribute("y",a.box.y),o[i].setAttribute("height",a.box.h);if(o.l.getAttribute("height")!=a.box.h)for(i in o)o[i].setAttribute("height",a.box.h);o.bl.getAttribute("x")!=t&&(o.l.setAttribute("width",Math.max(t,0)),o.bl.setAttribute("x",t),o.p.setAttribute("x",t+u.boundWeigth)),o.bl.getAttribute("width")!=u.boundWeigth&&(o.bl.setAttribute("width",u.boundWeigth),o.br.setAttribute("width",u.boundWeigth));var n=Math.max(e-t-2*u.boundWeigth,1);o.p.getAttribute("width")!=n&&o.p.setAttribute("width",n),o.r.getAttribute("x")!=e&&(o.br.setAttribute("x",e-u.boundWeigth),o.r.setAttribute("x",e)),o.r.getAttribute("width")!=Math.max(a.box.w-e,0)&&o.r.setAttribute("width",Math.max(a.box.w-e,0))})(a.toView(e.low,"x"),a.toView(e.high,"x"))}}function GraphLine(t,e,a,i){var n=this,s=document.createElementNS("http://www.w3.org/2000/svg","g");function r(t,e){var a="";if(!e)return"";for(var i=0;i<t.length;i++)a+=t[i]+","+e[i]+" ";return a}function o(t,e){for(var i=[],n=0;n<t.length;n++)i.push(a.toView(t[n],e));return i}s.className.baseVal="graphline",this.el=s,t&&t.appendChild(s),this.lines=new Map,this.update=function(){for(var t=0;t<e.graph.length;t++)for(var a=e.graph[t],l=o(a.data,"x"),h=0;h<a.child.length;h++){var u,c=a.child[h];n.lines.has(c.id)?u=n.lines.get(c.id):((u=document.createElementNS("http://www.w3.org/2000/svg","polyline")).setAttribute("stroke",c.color),i&&i.strokeWidth&&u.setAttribute("stroke-width",i.strokeWidth),s.appendChild(u),n.lines.set(c.id,u));var d=o(c.data,"y");u.setAttribute("points",r(l,d)),c.disable?"label-off"!==u.className.baseVal&&(u.className.baseVal="label-off"):"label-on"!==u.className.baseVal&&(u.className.baseVal="label-on")}}}function PointInfo(t,e,a){var i=this,n=document.createElementNS("http://www.w3.org/2000/svg","g");n.className.baseVal="grid";var s=document.createElementNS("http://www.w3.org/2000/svg","line");s.className.baseVal="pi-line",n.appendChild(s);var r=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");r.className.baseVal="pointinfo",r.setAttribute("x",0),r.setAttribute("y",0),r.setAttribute("width",0),r.setAttribute("height",500);var o=document.createElementNS("http://www.w3.org/1999/xhtml","div");o.className="pi-date";var l=document.createElementNS("http://www.w3.org/1999/xhtml","div");l.className="pi-values";var h,u=document.createElementNS("http://www.w3.org/1999/xhtml","div");function c(t){var e=document.createElementNS("http://www.w3.org/2000/svg","circle");return e.setAttribute("r",5),e.setAttribute("fill","none"),e.setAttribute("stroke",t.color),e.setAttribute("stroke-width",3),n.appendChild(e),e}function d(t){var e=document.createElement("div");e.className="pi-val-block",e.style.color=t.color;var a=document.createElement("div");a.textContent=t.name;var i=document.createElement("div");return i.className="pi-val",e.appendChild(i),e.appendChild(a),l.appendChild(e),i}u.className="pi-box",u.appendChild(o),u.appendChild(l),r.appendChild(u),n.appendChild(r);var p={},b={};this.setCapture=function(t){var e=throttle((function(e){var n=getMousePosition(e,t);h=a.toUnit(n.x),i.update()}),50);t.addEventListener("mousedown",e),t.addEventListener("touchstart",e),t.addEventListener("touchmove",e)},this.update=function(){if(h){s.getAttribute("y1")!=a.box.y&&s.setAttribute("y1",a.box.y),s.getAttribute("y2")!=a.box.h&&s.setAttribute("y2",a.box.h);var t=searchIdx(e.graph[0].data,h,2);if(t){x=e.graph[0].data[t],vx=a.toView(x,"x"),o.textContent=toDateStr(x,!0);for(var i=e.graph[0].child,n=0;n<i.length;n++){var l,u=i[n].id;l=p[u]?p[u]:p[u]=c(i[n]);var g,v=a.toView(i[n].data[t],"y");vx<a.box.x?r.style.visibility="hidden":r.style.visibility="","undefined"!=typeof vx&&vx>=-5&&void 0!==v&&v>=0&&(l.setAttribute("cx",vx),l.setAttribute("cy",v),s.setAttribute("x1",vx),s.setAttribute("x2",vx),r.setAttribute("x",vx)),g=b[u]?b[u]:b[u]=d(i[n]),r.getAttribute("width")!=140*i.length&&r.setAttribute("width",140*i.length),g.textContent=i[n].data[t],i[n].disable?(g.parentElement.style.display="none",l.style.display="none"):(g.parentElement.style.display="",l.style.display="")}}}},t.appendChild(n)}function GraphButtons(t,e){var a=document.createElement("div"),i={};function n(t){var i=document.createElement("span");i.style.color=t.color,i.className="span-input";var n="M 12,0a 11 11 0 1 0 1 0zM10,17l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z";i.innerHTML='<svg class="chx-svg" focusable="false" viewBox="0 0 24 24" aria-hidden="true" role="presentation"><path d="'+n+'"></path></svg><input id="'+t.id+'" type="checkbox" class="chx-input" checked="">';i.getElementsByTagName("input");var s=i.getElementsByTagName("input")[0],r=i.getElementsByTagName("path")[0];s.addEventListener("change",(function(a){a.target.checked?(t.disable=!1,r.setAttribute("d",n)):(t.disable=!0,r.setAttribute("d","M 12,0a 11 11 0 1 0 1 0zm 1,2a 9 9 0 1 1 -1 0Z")),e.update()}));var o=document.createElement("label");o.className="graph-button";var l=document.createElement("span");return l.className="chx-lbl",l.textContent=t.name,o.appendChild(i),o.appendChild(l),a.appendChild(o),a}t.appendChild(a),this.update=function(){if(0!==e.graph.length)for(var t=e.graph[0].child,a=0;a<t.length;a++){var s=t[a].id;i[s]?i[s]:i[s]=n(t[a])}},this.update()}function CaptionRect(t,e){var a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("fill","black"),a.setAttribute("opacity",0),a.setAttribute("stroke","black"),a.setAttribute("pointer-events","all"),this.el=a,t.appendChild(a),this.update=function(){a.setAttribute("x",e.box.x),a.setAttribute("y",e.box.y),a.setAttribute("width",e.box.w),a.setAttribute("height",e.box.h)}}function Chart(t,e){var a=document.getElementById(t);if(a){var i=document.createElement("div");i.className="chart";var n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","100%"),n.setAttribute("height","100%");var s=convData([e]),r=new ModelCoord;r.setData(s);var o=new Ranger;o.setSource(r);var l=new Transformer;l.setGraph(o.target);var h=new XScale(n,o.target.xAxis,l,6),u=new YScale(n,o.target.yAxis,l,6),c=new GraphLine(n,o.target,l,{strokeWidth:3}),d=new Transformer(!0),p=new PointInfo(n,o.target,l),b=new CaptionRect(n,d);p.setCapture(b.el);var g=new Transformer;g.setGraph(r);var v=new GraphLine(n,r,g),m=new Navigator(n,o,g,v.el);i.appendChild(n),a.appendChild(i);var w,f,x,A=new GraphButtons(a,r);g.registerObserver(m),g.registerObserver(v),l.registerObserver(c),l.registerObserver(h),l.registerObserver(u),l.registerObserver(p),d.registerObserver(b),o.registerObserver(m),o.registerObserver(l),r.registerObserver(g),r.registerObserver(o),r.registerObserver(A),y(),resize_t=throttle(y,100),w=window,f="resize",x=resize_t,null!=w&&void 0!==w&&(w.addEventListener?w.addEventListener(f,x,!1):w.attachEvent?w.attachEvent("on"+f,x):w["on"+f]=x)}function y(t){var e=parseFloat(getComputedStyle(a).fontSize),i=n.getBoundingClientRect(),s=Math.max(i.height/8,40);g.setBox(0,i.height-s,i.width,s),l.setBox(0,0,i.width,i.height-s-3*e),d.setBox(0,0,i.width,i.height-s-3*e)}}function searchIdx(t,e,a){for(var i,n,s=0,r=t.length-1;s<=r;)if(t[i=(s+r)/2|0]<e)s=i+1,n=-1;else{if(!(t[i]>e))return i;r=i-1,n=1}return 2===a?-1===n?void 0===t[i+1]||t[i+1]-e>e-t[i]?i:i+1:void 0===t[i-1]||t[i]-e<e-t[i-1]?i:i-1:1===a?-1===n&&void 0!==t[i+1]?i+1:i:-1===a?-1===n||void 0===t[i-1]?i:i-1:void 0}function Observable(){var t=this;this.observers=[],this.registerObserver=function(e){t.observers.push(e)},this.notifyAll=function(){t.observers.forEach((function(t){t.update()}))}}function Animatable(){var t=this;this.animate=function(e,a){var i=performance.now();var n=t.rafid=requestAnimationFrame((function s(r){if(n===t.rafid){var o=Math.min((performance.now()-i)/a,1);e(o),o<1&&requestAnimationFrame(s)}}))}}function Transformer(t){Observable.call(this),Animatable.call(this);var e,a,i=this;function n(t,e,a){return t/(e.high-e.low+(a||0))}function s(t,e,a){return(e-t)*a+t}this.setBox=function(t,e,a,n){this.box={x:t,y:e,w:a,h:n},i.update()},this.setGraph=function(t){this.axis={x:t.xAxis,y:t.yAxis},this.box&&this.update()},this.update=function(){if(t&&this.box)this.notifyAll();else if(this.axis&&this.box){var r={scale:e,offset:a},o={scale:{x:n(this.box.w,this.axis.x),y:n(this.box.h,this.axis.y,this.axis.y.high/10)},offset:{x:this.axis.x.low,y:this.axis.y.low}};r.scale?i.animate(function(t,n){return function(r){e={x:s(t.scale.x,n.scale.x,r),y:s(t.scale.y,n.scale.y,r)},a={x:s(t.offset.x,n.offset.x,r),y:s(t.offset.y,n.offset.y,r)},i.notifyAll()}}(r,o),100):(e=o.scale,a=o.offset,this.notifyAll())}},this.toView=function(t,n){return t=Math.trunc((t-a[n])*e[n]),"y"===n?i.box.y+i.box.h-t:t},this.toUnit=function(t,i){return i||(i="x"),t/e[i]+a[i]}}function ModelCoord(){Observable.call(this);var t=this;this.xAxis=new ModelAxies,this.yAxis=new ModelAxies({lowfixed:0,highflow:!0}),this.graph=[],this.setData=function(e){for(var a=[],i=[],n=0;n<e.length;n++){var s=e[n],r=new ModelGraph;r.data=s.x.data,a.push(r.data),t.graph.push(r);for(var o=s.x.y,l=0;l<o.length;l++){var h=new ModelGraph;h.data=o[l].data,h.name=o[l].name,h.color=o[l].color,h.id=o[l].id,i.push(h.data),r.child.push(h)}}t.xAxis.calc(a),t.yAxis.calc(i),t.notifyAll()},this.update=function(){for(var e=[],a=0;a<t.graph.length;a++)for(var i=t.graph[a].child,n=0;n<i.length;n++)i[n].disable||e.push(i[n].data);t.yAxis.calc(e),t.notifyAll()}}function convData(t){for(var e=[],a=0;a<t.length;a++){for(var i=t[a],n={x:{y:[]}},s=0;s<i.columns.length;s++){var r=i.columns[s][0];"x"===i.types[r]&&(n.x.data=i.columns[s].slice(1)),"line"===i.types[r]&&n.x.y.push({id:r,data:i.columns[s].slice(1),name:i.names[r],type:i.types[r],color:i.colors[r]})}e.push(n)}return e}function Ranger(){Observable.call(this);var t=this;this.setSource=function(e){this.source=e,this.target=new ModelCoord,xa=e.graph;for(var a=0;a<xa.length;a++)this.target.graph.push(xa[a].createLinkGraph());void 0===t.high&&(t.high=e.xAxis.high),void 0===t.low&&(t.low=e.xAxis.high-(e.xAxis.high-e.xAxis.low)/10),this.target.xAxis.origin=e.xAxis.low,this.setRange(t.low,t.high)},this.setRange=function(e,a){var i=t.target;if(!(a<=e)){t.low=e,t.high=a;var n=i.graph,s=[];i.xAxis.low=e,i.xAxis.high=a;for(var r=0;r<n.length;r++){if(n[r].source){var o=n[r].source.data,l=searchIdx(o,e,-1),h=searchIdx(o,a,1),u=Math.max(l-20,0);n[r].data=o.slice(u,h+20);for(var c=0;c<n[r].child.length;c++){var d=n[r].child[c];d.source&&(d.data=d.source.data.slice(u,h+20),d.disable=d.source.disable),d.source.disable||s.push(d.source.data.slice(l,h))}}i.yAxis.calc(s)}t.notifyAll()}},this.update=function(){this.setRange(t.low,t.high)}}function ModelAxies(t){var e=t||{},a=this;this.calc=function(t){a.low=void 0,a.high=void 0;var i=!1;null!=e.lowfixed&&(a.low=e.lowfixed,a.origin=e.lowfixed,i=!0);for(var n=[],s=[],r=0;r<t.length;r++)i||n.push(Math.min.apply(null,t[r])),s.push(Math.max.apply(null,t[r]));i||(a.low=Math.min.apply(null,n)),a.high=Math.max.apply(null,s)}}function ModelGraph(t){var e=this;this.data=[],this.child=[],this.createLinkGraph=function(){var t=new ModelGraph;t.source=e,t.name=e.name,t.color=e.color,t.id=e.id;for(var a=0;a<e.child.length;a++)t.child.push(e.child[a].createLinkGraph());return t}}function checkRaf(){for(var t=0,e=["ms","moz","webkit","o"],a=0;a<e.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[e[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[a]+"CancelAnimationFrame"]||window[e[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,a){var i=(new Date).getTime(),n=Math.max(0,16-(i-t)),s=window.setTimeout((function(){e(i+n)}),n);return t=i+n,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}checkRaf();